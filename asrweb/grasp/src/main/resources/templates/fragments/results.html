<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<body>
<div th:fragment="results" th:if="${results}">
    <a id="results-nav"></a>
    <div class="content-section-b">
        <div th:replace="fragments/help :: help"></div>
        <div class="row">
            <div id="heading">
                <h2><span class="node-label">Root</span> <small><span class="infer-label" th:text="*{inferenceType}"></span> reconstruction </small></h2>
                <hr class="h-divider"></hr>
            </div>
        </div>

        <div id="results" class="container-fluid" >
            <button type="button" id="branch-text-toggle" class="btn btn-default" onclick="toggle_branch_text()">View branch length | OFF</button>
            <!--<button type="button" id="additive-toggle" class="btn btn-default" onclick="toggle_additive()">Cladogram</button>-->
            <button type="button" id="saveButton" class="btn btn-default" onclick="save_phylo_svg_to_png()">Save Tree</button>


            <div id="phylo-tree" class="col-sm-12">


            </div>

            <!--<div id="poag" class="col-sm-12"></div>--> <!-- div for merged poags -->

                <div class="col-sm-12">
                    <div class="input-group">
                        <button type="button" id="savepoagButton" class="btn btn-default" onclick="save_poag_svg_to_png()">Save POAG</button>

                        <div class="btn-group" data-toggle="popover" data-placement="top" data-content="Change the colour scheme of the inferred character and representation of the distribution of characters in the sequence graphs.">
                            <button type="button" class="btn btn-default dropdown-toggle dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span id="selected-scheme">Clustal</span> | <small>Select other colour scheme...  </small><span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu">
                                <!--<li><a id="random" onclick="update_scheme('random')">GRASP <span id="random-selected" class="glyph-selected glyphicon glyphicon-ok" aria-hidden="true"></span></a></li>-->
                                <li><a id="cinema" onclick="update_scheme('cinema')">Cinema <span id="cinema-selected" class="disable glyph-selected glyphicon glyphicon-ok" aria-hidden="true"></span></a></li>
                                <li><a id="clustal" onclick="update_scheme('clustal')">Clustal <span id="clustal-selected" class="glyph-selected glyphicon glyphicon-ok" aria-hidden="true"></span></a></li>
                                <li><a id="hydrophob" onclick="update_scheme('hydrophob')">Hydrophobicity <span id="hydrophob-selected" class="disable glyph-selected glyphicon glyphicon-ok" aria-hidden="true"></span></a></li>
                                <li><a id="lesk" onclick="update_scheme('lesk')">Lesk <span id="lesk-selected" class="disable glyph-selected glyphicon glyphicon-ok" aria-hidden="true"></span></a></li>
                                <li><a id="ma" onclick="update_scheme('ma')">MAEditor <span id="ma-selected" class="disable glyph-selected glyphicon glyphicon-ok" aria-hidden="true"></span></a></li>
                                <li><a id="taylor" onclick="update_scheme('taylor')">Taylor <span id="taylor-selected" class="disable glyph-selected glyphicon glyphicon-ok" aria-hidden="true"></span></a></li>
                                <li><a id="zappo" onclick="update_scheme('zappo')">Zappo <span id="zappo-selected" class="disable glyph-selected glyphicon glyphicon-ok" aria-hidden="true"></span></a></li>
                            </ul>
                            <div class="input-group" data-toggle="popover" data-placement="bottom"  data-content="View the mutant library for the marginal reconstruction. Likely mutants are calculated using the Kullback-Leibler divergence on the set of possible characters. Default: 5 mutants are shown for each character position in the reconstructed ancestor.">
                                <button type="button" id="mutant-btn" class="btn btn-default disabled" data-toggle="button" aria-pressed="false" autocomplete="false" disabled="disabled">View mutants</button>
                                <div class="btn-group" id="mutant-input">
                                    <button class="btn btn-default" id="btn-mutant-down" type="button"><span class="glyphicon glyphicon-chevron-down" aria-hidden="true"></span></button>
                                    <input class="form-control" id="text-mutant" type="text" placeholder="0" maxlength="3" onkeyup="if (/\D/g.test(this.value)) this.value = this.value.replace(/\D/g,'')" />
                                    <button class="btn btn-default" id="btn-mutant-up" type="button"><span class="glyphicon glyphicon-chevron-up" aria-hidden="true"></span></button>
                                </div>
                            </div>
                        </div>
                        <script type="text/javascript">
                            /*<![CDATA[*/
                            if ($('.infer-label').text() === "joint") {
                                $('#mutant-btn').prop("disabled", true);
                                $('#mutant-btn').addClass("disabled");
                                $('#mutant-input').fadeOut();
                            } else {
                                $('#mutant-btn').prop("disabled", false);
                                $('#mutant-btn').removeClass("disabled");
                                $('#mutant-btn').removeClass("active");
                            }

                            $("#mutant-btn").click(function () {
                                $(this).delay(100).queue(function() {
                                    if ($("#mutant-btn").attr("aria-pressed") === 'true') {
                                        set_draw_mutants(true);
                                        $('#mutant-input').fadeIn();
                                        view_mutant_library($('#text-mutant').val());
                                    } else {
                                        set_draw_mutants(false);
                                        $('#mutant-input').fadeOut();
                                        poags.options.mutants.draw = false;
                                        redraw_poags();
                                    }
                                    $(this).dequeue();
                                });
                            });

                            $('#text-mutant').on('input', function() {
                                view_mutant_library($(this).val());
                            });

                            $('#btn-mutant-up').on('click', function() {
                                var old = parseInt($('#text-mutant').val());
                                if (isNaN(old)) {
                                    $('#text-mutant').val(1);
                                    view_mutant_library(1);
                                } else {
                                    $('#text-mutant').val(old + 1);
                                    view_mutant_library(old + 1);
                                }
                            });

                            $('#btn-mutant-down').on('click', function() {
                                var old = parseInt($('#text-mutant').val());
                                if (!isNaN(old) && old - 1 >= 0) {
                                    $('#text-mutant').val(old - 1);
                                    view_mutant_library(old - 1);
                                }
                            });

                            /*]]>*/
                        </script>
                    </div>

                    <div id="poag-all" class="col-sm-12" style="height: 3000px;">

                    </div>
                    
                    <script type="text/javascript" th:inline="javascript">
                            /*<![CDATA[*/
                            var update_scheme = function(scheme) {
                                 var glyphs = document.querySelectorAll(".glyph-selected");
                                  for (var i = 0; i < glyphs.length; i++) {
                                      if (!glyphs[i].classList.contains('disable')) {
                                          glyphs[i].classList.add('disable');
                                      }
                                  }
                                  document.querySelector("#" + scheme + "-selected").classList.remove('disable');
                                  document.getElementById("selected-scheme").textContent = document.getElementById(scheme).textContent;
                                  update_colour(scheme);
                            }

                            json_str = /*[[${graph}]]*/;
                            drawMutants = false;
                            // Set the SVG ID in the poags data struct
                            poags.options = poag_options;
                            poags.options.data.raw_svg_id = "poag-all";   // HTML representation
                            poags.options.data.target = "#poag-all";  // D3 representation
                            setup_poags(json_str, true, true, false, 'Inferred')

                            /**
                             * Add inferred graph to the graph array so that when more graphs
                             * are added we get a merged copy of the inferred + added graphs
                             */
                            graph_array.push(JSON.parse(json_str));
                            // Add the colours of the POAG assigned by name and merged_id
                            poags.options.poagColours["poag" + (Object.keys(poags.options.poagColours).length+1)] = poags.options.names_to_colour['Inferred'];
                            poags.options.name_to_merged_id[name] = ["poag" + (Object.keys(poags.options.poagColours).length+1)];
                            redraw_poags();


                    </script>

                </div>

            <div style="display: none;">
                <script type="text/javascript" th:inline="javascript">
                                /*<![CDATA[*/
                                    var label = /*[[${label}]]*/;
                                    set_recon_label(label);
                                    var recon = /*[[${tree}]]*/;
                                    set_phylo_params("#phylo-tree", recon);
                                    run_phylo_tree();
                                /*]]>*/
                </script>

            </div>

            <div class="row col-xs-12">
                <button id="download-toggle" class="btn btn-default col-xs-12" data-target="#download-form" data-toggle="collapse">Download Results...   <span class="glyphicon glyphicon-menu-down" aria-hidden="true"></span></button>
                <div th:replace="fragments/download_form :: download_form"></div>
                <script type="text/javascript">
                    $('#download-toggle').click( function(){
                        $(this).find('span').toggleClass('glyphicon-menu-down').toggleClass('glyphicon-menu-up');
                        $(this).delay(100).queue(function() {
                            if ($("#help-btn").attr("aria-pressed") === 'true') {
                                if ($("#download-form").attr("aria-expanded") === 'true') {
                                    $('#download-form [data-toggle="popover"]').popover('show');
                                } else {
                                    $('#download-form [data-toggle="popover"]').popover('hide');
                                }
                            }
                            $(this).dequeue();
                        });
                    });
                </script>
            </div>
        </div>
    </div>
</div>

</body>
</html>